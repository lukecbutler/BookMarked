<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-R-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reshelve Items</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 2rem;
            background-color: #f9f9f9;
        }
        h1, h2 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f0f0f0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        button {
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            color: white;
        }
        .reshelve-btn {
            background-color: #007bff;
        }
        .reshelve-btn:hover {
            background-color: #0056b3;
        }
        .reshelve-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #refresh-btn {
            background-color: #28a745;
            margin-bottom: 1rem;
        }
        #refresh-btn:hover {
            background-color: #218838;
        }
        #status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
        #status-message.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        #status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>
</head>
<body>

    <h1>Reshelve Items</h1>

    <button id="refresh-btn">Refresh List</button>
    <div id="status-message"></div>

    <h2>Items Awaiting Reshelving</h2>

    <table>
        <thead>
            <tr>
                <th>Item ID</th>
                <th>Title</th>
                <th>Shelf Code</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="items-list">
            </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const itemsListBody = document.getElementById('items-list');
            const statusMessage = document.getElementById('status-message');
            const refreshBtn = document.getElementById('refresh-btn');

            /**
             * Helper function to show status messages
             */
            function showStatus(message, isError = false) {
                statusMessage.textContent = message;
                statusMessage.className = isError ? 'error' : 'success';
            }

            /**
             * Fetches items from the API and populates the table
             */
            async function fetchItemsToReshelve() {
                itemsListBody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
                statusMessage.style.display = 'none'; // Hide old messages

                try {
                    const response = await fetch('/api/items-to-reshelve');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const items = await response.json();

                    // Clear the loading message
                    itemsListBody.innerHTML = ''; 

                    if (items.length === 0) {
                        itemsListBody.innerHTML = '<tr><td colspan="4">No items are currently awaiting reshelving.</td></tr>';
                        return;
                    }

                    // Populate the table with items
                    items.forEach(item => {
                        const row = document.createElement('tr');
                        row.dataset.itemId = item.ItemID; // Add for easy removal
                        row.innerHTML = `
                            <td>${item.ItemID}</td>
                            <td>${item.ItemTitle}</td>
                            <td>${item.ShelfCode}</td>
                            <td>
                                <button class="reshelve-btn" data-item-id="${item.ItemID}">
                                    Reshelve
                                </button>
                            </td>
                        `;
                        itemsListBody.appendChild(row);
                    });

                } catch (error) {
                    console.error('Error fetching items:', error);
                    itemsListBody.innerHTML = '<tr><td colspan="4" style="color: red;">Could not load items.</td></tr>';
                    showStatus(`Error fetching items: ${error.message}`, true);
                }
            }

            /**
             * Handles the POST request to reshelve a single item
             */
            async function reshelveItem(itemId, buttonElement) {
                buttonElement.disabled = true; // Prevent double-clicks
                buttonElement.textContent = 'Reshelving...';

                try {
                    const response = await fetch('/api/reshelve', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // Your backend expects 'item_id' in the payload
                        body: JSON.stringify({ item_id: itemId }) 
                    });

                    const result = await response.json();

                    if (result.ok) {
                        showStatus(result.message, false);
                        // Find the row and remove it from the table
                        const rowToRemove = buttonElement.closest('tr');
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                    } else {
                        throw new Error(result.error || 'Unknown error occurred');
                    }

                } catch (error) {
                    console.error('Error reshelving item:', error);
                    showStatus(`Error: ${error.message}`, true);
                    buttonElement.disabled = false; // Re-enable button on failure
                    buttonElement.textContent = 'Reshelve';
                }
            }

            // --- Event Listeners ---

            // 1. Handle clicks on the "Reshelve" buttons using event delegation
            itemsListBody.addEventListener('click', (event) => {
                // Check if the clicked element is a reshelve button
                if (event.target.classList.contains('reshelve-btn')) {
                    const itemId = event.target.dataset.itemId;
                    reshelveItem(itemId, event.target);
                }
            });

            // 2. Handle clicks on the "Refresh" button
            refreshBtn.addEventListener('click', fetchItemsToReshelve);

            // 3. Initial fetch when the page loads
            fetchItemsToReshelve();
        });
    </script>
</body>
</html>