<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BookMarked · Checkout</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, rgba(232,245,233,0.5), rgba(200,230,201,0.5)), url('https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 2rem;
    }

    .header {
      text-align: center;
      margin-top: 1rem;
      margin-bottom: 2rem;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 900;
      color: #1b5e20;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .header p {
      font-size: 1rem;
      color: #333;
      margin-bottom: 0;
    }

    .card.checkout-card {
      background: rgba(255,255,255,0.95);
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      padding: 2.25rem 2rem;
      width: 100%;
      max-width: 640px;
      position: relative;
      overflow: hidden;
    }

    .card.checkout-card h2 {
      font-size: 2rem;
      color: #1b5e20;
      margin-bottom: 1.25rem;
      font-weight: 700;
      text-align: center;
    }

    .form-label { color: #1b5e20; font-weight: 600; }
    .form-control, .form-select {
      background-color: #f1f8e9;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
    }
    .form-control:focus, .form-select:focus {
      border-color: #2e7d32;
      box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.15);
      background-color: #fff;
    }

    .btn-success {
      background-color: #2e7d32;
      border-color: #2e7d32;
      border-radius: 12px;
      padding: 0.6rem 1.25rem;
      font-weight: 600;
    }
    .btn-success:hover { background-color: #1b5e20; border-color: #1b5e20; }

    .picked-box {
      margin-top: 0.75rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      color: #2e7d32;
      min-height: 1.25rem;
    }

    footer {
      margin-top: 1.25rem;
      color: #666;
      font-size: 0.9rem;
      text-align: center;
    }

    .card.checkout-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?auto=format&fit=crop&w=800&q=80')
                  center/cover no-repeat;
      opacity: 0.15;
      pointer-events: none;
      z-index: 0;
    }

    .card.checkout-card > * { position: relative; z-index: 1; }

    @media (max-width: 576px) {
      .card.checkout-card::before { background-size: 220px auto; }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>BookMarked</h1>
    <p>WPL Library Software · Checkout</p>
  </div>

  <div class="card checkout-card">
    <h2>Checkout (single item · demo)</h2>

    <form method="post" action="/checkout" id="checkout-form" class="mt-2">
      <div class="mb-3">
        <label for="patron_id" class="form-label">Patron ID</label>
        <input name="patron_id" id="patron_id" type="number" class="form-control" required>
      </div>

      <!-- Membership panel -->
      <div class="mb-3 p-3 border rounded-3 bg-white">
        <h5 class="mb-3" style="color:#1b5e20; font-weight:700;">Membership Status</h5>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <button type="button" id="btn-check-membership" class="btn btn-outline-success btn-sm">Check Membership</button>
          <span id="membership-status" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
        </div>
        <div id="extend-controls" class="mt-3" style="display:none;">
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <label for="extend-date" class="col-form-label">New expiration date:</label>
    </div>
    <div class="col-auto">
      <input id="extend-date" type="date" class="form-control" />
    </div>
    <div class="col-auto">
      <button type="button" id="btn-extend-membership" class="btn btn-success btn-sm">Save</button>
    </div>
    <div class="col-auto">
      <button type="button" id="btn-cancel-extend" class="btn btn-outline-secondary btn-sm">Abort</button>
    </div>
    <div class="col-12 mt-1">
      <span id="extend-result" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
    </div>
  </div>
</div>

        
      </div>
<<<<<<< HEAD
      <!-- /Membership panel -->
      <!-- Fine Balance panel -->
=======
      <!-- Fine Balance panel (inside the card, below Membership) -->
>>>>>>> a8072e0c799d0ce3992b14566c8aa67e75bca779
<div class="mb-3 p-3 border rounded-3 bg-white">
  <h5 class="mb-3" style="color:#1b5e20; font-weight:700;">Fine Balance</h5>

  <div class="d-flex flex-wrap align-items-center gap-2">
    <button type="button" id="btn-check-fines" class="btn btn-outline-success btn-sm">Check Fines</button>
    <span id="fine-status" class="ms-2" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
  </div>

  <div id="fine-actions" class="mt-3" style="display:none;">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <button type="button" id="btn-pay-fines" class="btn btn-success btn-sm">Pay Fines</button>
      <button type="button" id="btn-cancel-fines" class="btn btn-outline-secondary btn-sm">Cancel Transaction</button>
      <span id="fine-result" class="ms-2" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
    </div>
  </div>
</div>

<<<<<<< HEAD
       
=======
>>>>>>> a8072e0c799d0ce3992b14566c8aa67e75bca779

      <div class="mb-3">
        <label for="item_type" class="form-label">Item Type</label>
        <select id="item_type" class="form-select" disabled>
          <option value="">-- select type --</option>
        </select>
      </div>

      <div class="mb-4">
        <label for="item_id" class="form-label">Item</label>
        <select name="item_id" id="item_id" class="form-select" required disabled>
          <option value="">-- select item --</option>
        </select>
      </div>

<<<<<<< HEAD

      <button type="submit" id="btn-checkout" class="btn btn-success w-100" disabled>Checkout</button>

=======
      <button type="submit" id="btn-checkout" class="btn btn-success w-100" disabled>Checkout</button>
>>>>>>> a8072e0c799d0ce3992b14566c8aa67e75bca779
    </form>
    <div id="checkout-limit-alert" class="alert alert-warning mt-3" style="display:none;">
  <div id="checkout-limit-text">
    Patron has exceeded number of checkouts, please check in a book to checkout another one.
  </div>
  <button type="button" id="btn-close-transaction" class="btn btn-outline-secondary btn-sm mt-2">
    Close transaction
  </button>
</div>

    <div id="picked" class="picked-box"></div>

    <footer>
      © 2025 BookMarked | All rights reserved
    </footer>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!--  Existing functions and handlers -->
  <script>
    async function loadTypes() {
      const resp = await fetch('/api/itemtypes');
      const types = await resp.json();
      const sel = document.getElementById('item_type');
      sel.innerHTML = '<option value="">-- select type --</option>';
      types.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.TypeID;
        opt.textContent = t.TypeName;
        sel.appendChild(opt);
      });
    }

    async function loadItems(typeId) {
      const url = '/api/items' + (typeId ? ('?type_id=' + encodeURIComponent(typeId)) : '');
      const resp = await fetch(url);
      const items = await resp.json();
      const sel = document.getElementById('item_id');
      sel.innerHTML = '<option value="">-- select item --</option>';
      items.forEach(i => {
        const opt = document.createElement('option');
        opt.value = i.ItemID;
        opt.textContent = i.ItemTitle + ' (ID ' + i.ItemID + ')';
        sel.appendChild(opt);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadTypes();
      document.getElementById('item_type').addEventListener('change', (e) => {
        loadItems(e.target.value);
        document.getElementById('picked').textContent = '';
      });
      document.getElementById('item_id').addEventListener('change', (e) => {
        const itemText = e.target.options[e.target.selectedIndex]?.text || '';
        document.getElementById('picked').textContent = itemText ? ('Selected: ' + itemText) : '';
      });
    });
  </script>

  <!--Membership handlers -->
  <script>
  document.getElementById('btn-check-membership')?.addEventListener('click', async () => {
    const patronId = document.getElementById('patron_id').value;
    if (!patronId) {
      alert('Enter Patron ID first');
      return;
    }

    const resp = await fetch(`/api/check_membership?patron_id=${patronId}`);
    const data = await resp.json();
    const statusEl = document.getElementById('membership-status');
    const extendDiv = document.getElementById('extend-controls');

    if (!data.ok) {
      statusEl.textContent = data.error || 'Error checking membership';
      extendDiv.style.display = 'none';
      return;
    }

    if (data.expired) {
      statusEl.textContent = `Expired on ${data.expiration_date}`;
      extendDiv.style.display = 'block';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('extend-date').value = today;
    } else {
    statusEl.textContent = `Active until ${data.expiration_date}`;
    extendDiv.style.display = 'none';  // hide controls if membership is active
    document.getElementById('extend-result').textContent = '';
    }

  });

  document.getElementById('btn-extend-membership')?.addEventListener('click', async () => {
    const patronId = document.getElementById('patron_id').value;
    const newDate = document.getElementById('extend-date').value;
    const resultEl = document.getElementById('extend-result');

    if (!patronId) {
      alert('Enter Patron ID first');
      return;
    }
    if (!newDate) {
      alert('Pick a new expiration date');
      return;
    }

    const resp = await fetch('/api/extend_membership', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ patron_id: patronId, expiration_date: newDate })
    });
    const data = await resp.json();

    if (data.ok) {
      resultEl.textContent = data.message + ' New Expiration: ' + data.new_expiration;
      document.getElementById('membership-status').textContent = `Active until ${data.new_expiration}`;
      document.getElementById('extend-controls').style.display = 'none';
    } else {
      resultEl.textContent = data.error || 'Error extending membership';
    }
  });

  document.getElementById('btn-cancel-extend')?.addEventListener('click', () => {
    const extendBox = document.getElementById('extend-controls');
    const extendResult = document.getElementById('extend-result');
    if (extendBox) extendBox.style.display = 'none';
    if (extendResult) extendResult.textContent = '';

    window.location.href = "/";
  });
</script>

  <script>
let finesCleared = false;

function lockItemControls(locked) {
  document.getElementById('item_type').disabled = locked;
  document.getElementById('item_id').disabled = locked;
  document.getElementById('btn-checkout').disabled = locked;
}

// Relock & clear fines messages when Patron ID changes
document.getElementById('patron_id')?.addEventListener('input', () => {
  finesCleared = false;
  lockItemControls(true);
  const s = document.getElementById('fine-status');
  const r = document.getElementById('fine-result');
  const a = document.getElementById('fine-actions');
  if (s) s.textContent = '';
  if (r) r.textContent = '';
  if (a) a.style.display = 'none';
});

// --- API helpers ---
async function apiCheckFines(patronId){
  const resp = await fetch(`/api/check_fines?patron_id=${encodeURIComponent(patronId)}`);
  return resp.json();
}
async function apiPayFines(patronId){
  const resp = await fetch('/api/pay_fines', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ patron_id: Number(patronId) })
  });
  return resp.json();
}

// --- Check Fines button ---
document.getElementById('btn-check-fines')?.addEventListener('click', async () => {
  const pid = document.getElementById('patron_id').value;
  const status = document.getElementById('fine-status');
  const actions = document.getElementById('fine-actions');
  const result = document.getElementById('fine-result');

  if (!pid) { alert('Enter Patron ID first'); return; }

  try {
    status.textContent = 'Checking fines...';
    result.textContent = '';
    const data = await apiCheckFines(pid);

    if (!data.ok) {
      status.textContent = data.error || 'Error checking fines.';
      actions.style.display = 'none';
      lockItemControls(true);
      return;
    }

    const due = Number(data.fines_due || 0);
    if (due > 0) {
      status.textContent = `Fines due: $${due.toFixed(2)}.`;
      actions.style.display = 'flex';      
      lockItemControls(true);              
    } else {
      status.textContent = 'No fines outstanding.';
      actions.style.display = 'none';
      finesCleared = true;
      lockItemControls(false);             
    }
  } catch (e) {
    status.textContent = 'Network error while checking fines.';
    actions.style.display = 'none';
    lockItemControls(true);
  }
});

// --- Pay Fines button ---
document.getElementById('btn-pay-fines')?.addEventListener('click', async () => {
  const pid = document.getElementById('patron_id').value;
  const result = document.getElementById('fine-result');
  const status = document.getElementById('fine-status');
  const actions = document.getElementById('fine-actions');

  if (!pid) { alert('Enter Patron ID first'); return; }

  try {
    result.textContent = 'Paying...';
    const data = await apiPayFines(pid);

    if (data.ok) {
      result.textContent = `Paid $${(data.previous_fines || 0).toFixed(2)}.`;
      status.textContent = 'No fines outstanding.';
      actions.style.display = 'none';
      finesCleared = true;
      lockItemControls(false);             
    } else {
      result.textContent = data.error || 'Payment failed.';
      finesCleared = false;
      lockItemControls(true);
    }
  } catch (e) {
    result.textContent = 'Network error while paying.';
    finesCleared = false;
    lockItemControls(true);
  }
});

// --- Cancel Transaction button ---
document.getElementById('btn-cancel-fines')?.addEventListener('click', () => {
  finesCleared = false;
  lockItemControls(true);
  document.getElementById('fine-result').textContent = 'Cancelled.';
  alert('Transaction cancelled due to unpaid fines.');
});

document.getElementById('checkout-form')?.addEventListener('submit', (e) => {
  if (!finesCleared) {
    e.preventDefault();
    alert('Please clear fines (or confirm there are none) before proceeding.');
  }
});
</script>
<script>
  // Cancel Fine / Abort transaction
  document.getElementById('btn-cancel-fines')?.addEventListener('click', () => {
    const fineActions = document.getElementById('fine-actions');
    const fineStatus = document.getElementById('fine-status');
    const fineResult = document.getElementById('fine-result');

    if (fineActions) fineActions.style.display = 'none';
    if (fineStatus) fineStatus.textContent = '';
    if (fineResult) fineResult.textContent = '';

    window.location.href = "/";
  });
</script>
<script>
document.getElementById('checkout-form')?.addEventListener('submit', async (e) => {

  e.preventDefault();

  const form = e.target;
  const fd = new FormData(form);
  const payload = Object.fromEntries(fd.entries());

  const resp = await fetch('/checkout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await resp.json();

  if (!data.ok && data.error && data.error.includes('Individual checkout limit reached')) {
    const alertBox = document.getElementById('checkout-limit-alert');
    const alertText = document.getElementById('checkout-limit-text');
    alertText.textContent = "Patron has exceeded number of checkouts, please check in a book to checkout another one.";
    alertBox.style.display = 'block';
    return;
  }

  if (data.ok) {
    alert('Checkout successful!');
    form.reset();
    document.getElementById('picked').textContent = '';
    const alertBox = document.getElementById('checkout-limit-alert');
    if (alertBox) alertBox.style.display = 'none';
  } else {
    alert(data.error || data.message || 'Checkout failed.');
  }
});

document.getElementById('btn-close-transaction')?.addEventListener('click', () => {
  window.location.href = "/";
});
</script>



<<<<<<< HEAD
      if (data.ok) {
        resultEl.textContent = data.message + ' New Expiration: ' + data.new_expiration;
        document.getElementById('membership-status').textContent = `Active until ${data.new_expiration}`;
        document.getElementById('extend-controls').style.display = 'none';
      } else {
        resultEl.textContent = data.error || 'Error extending membership';
      }
    });
  </script>
  <script>
let finesCleared = false;

function lockItemControls(locked) {
  document.getElementById('item_type').disabled = locked;
  document.getElementById('item_id').disabled = locked;
  document.getElementById('btn-checkout').disabled = locked;
}

// Relock & clear fines messages when Patron ID changes
document.getElementById('patron_id')?.addEventListener('input', () => {
  finesCleared = false;
  lockItemControls(true);
  const s = document.getElementById('fine-status');
  const r = document.getElementById('fine-result');
  const a = document.getElementById('fine-actions');
  if (s) s.textContent = '';
  if (r) r.textContent = '';
  if (a) a.style.display = 'none';
});

// --- API helpers ---
async function apiCheckFines(patronId){
  const resp = await fetch(`/api/check_fines?patron_id=${encodeURIComponent(patronId)}`);
  return resp.json();
}
async function apiPayFines(patronId){
  const resp = await fetch('/api/pay_fines', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ patron_id: Number(patronId) })
  });
  return resp.json();
}

// --- Check Fines button ---
document.getElementById('btn-check-fines')?.addEventListener('click', async () => {
  const pid = document.getElementById('patron_id').value;
  const status = document.getElementById('fine-status');
  const actions = document.getElementById('fine-actions');
  const result = document.getElementById('fine-result');

  if (!pid) { alert('Enter Patron ID first'); return; }

  try {
    status.textContent = 'Checking fines...';
    result.textContent = '';
    const data = await apiCheckFines(pid);

    if (!data.ok) {
      status.textContent = data.error || 'Error checking fines.';
      actions.style.display = 'none';
      lockItemControls(true);
      return;
    }

    const due = Number(data.fines_due || 0);
    if (due > 0) {
      status.textContent = `Fines due: $${due.toFixed(2)}.`;
      actions.style.display = 'flex';      // show Pay / Cancel
      lockItemControls(true);              // keep locked until paid
    } else {
      status.textContent = 'No fines outstanding.';
      actions.style.display = 'none';
      finesCleared = true;
      lockItemControls(false);             // unlock item type/item/checkout
    }
  } catch (e) {
    status.textContent = 'Network error while checking fines.';
    actions.style.display = 'none';
    lockItemControls(true);
  }
});

// --- Pay Fines button ---
document.getElementById('btn-pay-fines')?.addEventListener('click', async () => {
  const pid = document.getElementById('patron_id').value;
  const result = document.getElementById('fine-result');
  const status = document.getElementById('fine-status');
  const actions = document.getElementById('fine-actions');

  if (!pid) { alert('Enter Patron ID first'); return; }

  try {
    result.textContent = 'Paying...';
    const data = await apiPayFines(pid);

    if (data.ok) {
      result.textContent = `Paid $${(data.previous_fines || 0).toFixed(2)}.`;
      status.textContent = 'No fines outstanding.';
      actions.style.display = 'none';
      finesCleared = true;
      lockItemControls(false);             // UNLOCK HERE
    } else {
      result.textContent = data.error || 'Payment failed.';
      finesCleared = false;
      lockItemControls(true);
    }
  } catch (e) {
    result.textContent = 'Network error while paying.';
    finesCleared = false;
    lockItemControls(true);
  }
});

// --- Cancel Transaction button ---
document.getElementById('btn-cancel-fines')?.addEventListener('click', () => {
  finesCleared = false;
  lockItemControls(true);
  document.getElementById('fine-result').textContent = 'Cancelled.';
  alert('Transaction cancelled due to unpaid fines.');
});

// --- Guard submit: require fines cleared first ---
document.getElementById('checkout-form')?.addEventListener('submit', (e) => {
  if (!finesCleared) {
    e.preventDefault();
    alert('Please clear fines (or confirm there are none) before proceeding.');
  }
});
</script>

=======
>>>>>>> a8072e0c799d0ce3992b14566c8aa67e75bca779
</body>
</html>
